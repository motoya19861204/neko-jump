<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ねこジャンプ — 完全版</title>
<style>
:root{
  --bg:#cfe9ff;
  --panel:#ffffffcc;
  --accent:#ff7b6b;
  --accent-dark:#e05e50;
}
*{box-sizing:border-box;user-select:none;-webkit-user-select:none;-ms-user-select:none}
html,body{height:100%;margin:0;padding:0;background:linear-gradient(#cfe9ff,#eaf7ff);overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif}
#gameWrap{
  max-width:640px;
  height:100vh;
  margin:0 auto;
  padding:8px;
  background:var(--panel);
  border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
  position:relative;
  display:flex;
  flex-direction:column;
}
/* header: minimal */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding:4px 6px;
  min-height:34px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
h1{
  font-size:14px;
  margin:0;
  line-height:1;
  color:#222;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:60%;
}
.header-info{display:flex;gap:8px;align-items:center;font-size:13px;color:#333}

/* canvas */
#canvas{
  width:100%;
  flex:1 1 auto;
  border-radius:10px;
  display:block;
  background:linear-gradient(#e8f6ff,#ffffff);
  touch-action:none; /* prevent default gestures */
  -webkit-touch-callout:none;
}

/* center start button */
#startBtn{
  position:absolute;
  z-index:30;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  padding:14px 22px;
  font-size:20px;
  border-radius:12px;
  border:none;
  background:linear-gradient(180deg,var(--accent),var(--accent-dark));
  color:#fff;
  font-weight:700;
  box-shadow:0 8px 18px rgba(0,0,0,.18);
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
}

/* touchpad at bottom, always visible */
.touchpad{
  display:flex;
  gap:28px;
  justify-content:center;
  align-items:center;
  padding:10px 6px;
  flex-shrink:0;
  background:transparent;
  margin-top:6px;
}
.tp-btn{
  width:90px;
  height:68px;
  border-radius:12px;
  border:2px solid rgba(0,0,0,.18);
  background:#fff;
  font-size:24px;
  font-weight:700;
  touch-action:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
  -webkit-tap-highlight-color: transparent;
  box-shadow:0 6px 12px rgba(0,0,0,.08);
}

/* overlay for game over or messages */
.overlay{
  position:fixed;
  left:0;top:0;right:0;bottom:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.28);
  z-index:60;
}
.panel{
  background:#fff;
  padding:14px;
  border-radius:10px;
  box-shadow:0 12px 32px rgba(0,0,0,.18);
  min-width:260px;
}
.hidden{display:none}

/* confetti area */
.confetti{
  position:fixed;
  left:0;top:0;width:100%;height:100%;
  pointer-events:none;z-index:70;
}

/* small helpers */
.small{font-size:13px;color:#333}
button.secondary{background:#666;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}

/* prevent default long-press behaviour on iOS */
html,body,#gameWrap,button,canvas{ -webkit-touch-callout: none; -webkit-user-select: none; -ms-user-select:none }
</style>
</head>
<body>
<div id="gameWrap">
  <header id="gameHeader">
    <h1 id="gameTitle">ねこジャンプ — コインをあつめよう</h1>
    <div class="header-info">
      <div class="small">獲得: <span id="score">0</span> 円</div>
      <div class="small">ハイスコア: <span id="high">0</span> 円</div>
    </div>
  </header>

  <!-- canvas（高さは JS で調整） -->
  <canvas id="canvas" width="480" height="640"></canvas>

  <!-- touch controls -->
  <div class="touchpad" id="touchpad">
    <button class="tp-btn" id="leftBtn" aria-label="left">◀</button>
    <button class="tp-btn" id="rightBtn" aria-label="right">▶</button>
  </div>

  <!-- center start button -->
  <button id="startBtn">スタート</button>
</div>

<!-- overlay (hidden until game over) -->
<div id="overlay" class="overlay hidden">
  <div class="panel" id="panelContent"></div>
</div>

<!-- confetti -->
<div id="confettiArea" class="confetti"></div>

<script>
// ----------------- 設定 -----------------
const CAT_IMAGE_PATH = 'cat.png';        // 猫画像（任意）
const BGM_PATH = 'bgm.mp3';              // ループBGM（任意）
const GAMEOVER_SOUND_PATH = 'gameover.mp3'; // ゲームオーバー音（任意）
const COIN_VALUE = 50;
const STORAGE_KEY = 'neko_jump_highscore_v1';

// DOM
const gameWrap = document.getElementById('gameWrap');
const header = document.getElementById('gameHeader');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const scoreEl = document.getElementById('score');
const highEl = document.getElementById('high');
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const touchpad = document.getElementById('touchpad');
const overlay = document.getElementById('overlay');
const panelContent = document.getElementById('panelContent');
const confettiArea = document.getElementById('confettiArea');

let W = 480, H = 640;
let devicePixelRatioCached = window.devicePixelRatio || 1;

// input state
let keys = { left:false, right:false };
let touchLeft = false, touchRight = false;

// game state
let player, platforms, coins, score, highScore, running, started, lastTime;

// audio
const bgm = new Audio(BGM_PATH);
bgm.loop = true;
const gameoverSound = new Audio(GAMEOVER_SOUND_PATH);

// load highscore
highScore = parseInt(localStorage.getItem(STORAGE_KEY) || '0', 10) || 0;
highEl.textContent = highScore;

// load cat image
let catImg = new Image();
let catLoaded = false;
catImg.src = CAT_IMAGE_PATH;
catImg.onload = ()=>{ catLoaded = true; };
catImg.onerror = ()=>{ catLoaded = false; };

// utility
function rand(min,max){ return Math.random()*(max-min)+min; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

// ----------------- レイアウト / リサイズ -----------------
function resizeCanvas(){
  // available width = gameWrap clientWidth minus padding
  const wrapRect = gameWrap.getBoundingClientRect();
  const headerH = header.getBoundingClientRect().height;
  const padH = touchpad.getBoundingClientRect().height;
  // give a little spacing
  const availableW = Math.floor(wrapRect.width - 0);
  const availableH = Math.floor(Math.max(200, wrapRect.height - headerH - padH - 8));
  // CSS size
  canvas.style.width = availableW + 'px';
  canvas.style.height = availableH + 'px';

  // handle devicePixelRatio for crisp rendering
  const ratio = window.devicePixelRatio || 1;
  devicePixelRatioCached = ratio;
  canvas.width = Math.floor(availableW * ratio);
  canvas.height = Math.floor(availableH * ratio);
  // make drawing operate in CSS pixels by scaling context
  ctx.setTransform(ratio,0,0,ratio,0,0);

  W = availableW;
  H = availableH;
}
window.addEventListener('resize', resizeCanvas);
window.addEventListener('orientationchange', ()=> setTimeout(resizeCanvas,200));
resizeCanvas();

// prevent page scrolling when interacting with canvas/touchpad
document.body.addEventListener('touchmove', function(e){
  // if interacting with canvas or touchpad, prevent default scroll
  if(e.target === canvas || e.target.closest('.touchpad') || e.target === leftBtn || e.target === rightBtn){
    e.preventDefault();
  }
}, { passive:false });

// prevent selection / long-press context menu on specific elements
[canvas, leftBtn, rightBtn, startBtn].forEach(el=>{
  el.addEventListener('contextmenu', e=> e.preventDefault());
  el.addEventListener('selectstart', e=> e.preventDefault());
});

// ----------------- ゲームロジック -----------------
function resetGame(){
  player = { x: W/2, y: H - 120, w:48, h:48, vx:0, vy:0, onGround:false };
  platforms = [];
  coins = [];
  score = 0;
  scoreEl.textContent = score;
  running = false;
  started = false;
  lastTime = null;
}

function ensureStartingPlatforms(){
  platforms.push({ x: Math.floor(W*0.12), y: H - 36, w: Math.floor(W*0.76), h:12, moving:false, dir:1 });
  platforms.push({ x: clamp(W/2 - 80, 12, W-120), y: H - 140, w:120, h:12, moving:false, dir:1 });
  platforms.push({ x: clamp(W/2 + 100, 12, W-140), y: H - 240, w:100, h:12, moving:false, dir:1 });
  coins.push({ x: W/2 - 20, y: H - 160, r:9, claimed:false });
  coins.push({ x: W/2 + 140, y: H - 260, r:9, claimed:false });
}

function startGame(){
  if(started) return;
  resetGame();
  ensureStartingPlatforms();
  player.x = W/2;
  player.y = H - 220;
  running = true;
  started = true;
  lastTime = null;
  // hide start button
  startBtn.style.display = 'none';
  // hide overlay if any
  overlay.classList.add('hidden');
  // try play BGM (must be initiated by user action — startBtn click is user gesture)
  try{ bgm.currentTime = 0; bgm.play().catch(()=>{}); }catch(e){}
  requestAnimationFrame(loop);
}

function spawnPlatformsIfNeeded(){
  const minY = platforms.length ? Math.min(...platforms.map(p=>p.y)) : H;
  const genTarget = -1200;
  let highest = minY;
  // We'll base new platforms on the current highest platform
  while(highest > genTarget){
    const step = rand(80, 160);
    const newY = highest - step;
    const w = rand(60, 160);
    const last = platforms.reduce((a,b)=> a.y < b.y ? a : b, platforms[0]);
    const baseX = last ? (last.x + last.w/2) : W/2;
    const maxXOffset = Math.min(200, Math.max(120, W*0.35));
    let x = clamp(baseX + rand(-maxXOffset, maxXOffset) - w/2, 12, W - w - 12);
    const moving = Math.random() < 0.12;
    platforms.push({ x:x, y:newY, w:w, h:12, moving:moving, dir: Math.random()<0.5?1:-1 });
    if(Math.random() < 0.35){
      coins.push({ x: x + w/2, y: newY - 28, r:9, claimed:false });
    }
    highest = newY;
  }
}

function update(dt){
  if(!running) return;
  // horizontal input
  const targetVx = (keys.left||touchLeft) ? -260 : (keys.right||touchRight) ? 260 : 0;
  player.vx += (targetVx - player.vx) * 0.12;
  // gravity
  player.vy += 2000 * dt;
  // integrate
  player.x += player.vx * dt;
  player.y += player.vy * dt;
  player.x = clamp(player.x, 20, W-20);

  // platforms movement
  for(const p of platforms){
    if(p.moving){ p.x += p.dir * 60 * dt; if(p.x < 8) p.dir = 1; if(p.x + p.w > W-8) p.dir = -1; }
  }

  // collision detection (only when falling)
  player.onGround = false;
  const prevBottom = player.y - player.vy*dt + player.h/2;
  const curBottom = player.y + player.h/2;
  for(const p of platforms){
    const platTop = p.y;
    if(prevBottom <= platTop && curBottom >= platTop){
      // horizontal overlap
      if(player.x + player.w/2 > p.x && player.x - player.w/2 < p.x + p.w){
        // land on platform
        player.y = platTop - player.h/2;
        player.vy = -820; // auto jump boost
        player.onGround = true;
      }
    }
  }

  // coins
  for(const c of coins){
    if(c.claimed) continue;
    const dx = player.x - c.x;
    const dy = player.y - c.y;
    if(Math.hypot(dx,dy) < c.r + player.h/2 - 6){
      c.claimed = true;
      score += COIN_VALUE;
      scoreEl.textContent = score;
    }
  }

  // camera: if player goes above threshold, move world down
  const upper = H * 0.35;
  if(player.y < upper){
    const diff = upper - player.y;
    player.y = upper;
    for(const p of platforms) p.y += diff;
    for(const c of coins) c.y += diff;
  }

  // cleanup
  platforms = platforms.filter(p => p.y < H + 300);
  coins = coins.filter(c => !c.claimed && c.y < H + 300);

  // spawn ahead
  spawnPlatformsIfNeeded();

  // lose if fall below screen
  if(player.y - player.h/2 > H + 80){
    endGame();
  }
}

function draw(){
  // clear (CSS pixels)
  ctx.clearRect(0,0,W,H);

  // background subtle (you can paint gradient but canvas already has CSS background)
  // draw platforms
  for(const p of platforms){
    ctx.fillStyle = '#7a5a3c';
    ctx.fillRect(p.x, p.y - p.h, p.w, p.h);
    ctx.fillStyle = '#cfa';
    ctx.fillRect(p.x+4, p.y - p.h - 6, p.w-8, 6);
  }

  // coins
  for(const c of coins){
    if(c.claimed) continue;
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);
    ctx.fillStyle = '#ffd700';
    ctx.fill();
    ctx.strokeStyle = '#c78f00';
    ctx.stroke();
  }

  // player
  const px = player.x, py = player.y;
  if(catLoaded){
    ctx.drawImage(catImg, px - player.w/2, py - player.h/2, player.w, player.h);
  } else {
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.ellipse(px, py, player.w/2+2, player.h/2+2,0,0,Math.PI*2);
    ctx.fill();
    ctx.font = '34px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('😺', px, py);
  }

  // if not running, show subtle hint / shadow
  if(!running){
    // dim overlay to hint start
    ctx.fillStyle = 'rgba(255,255,255,0.0)';
    ctx.fillRect(0,0,W,H);
  }
}

function loop(ts){
  if(!running) return;
  if(!lastTime) lastTime = ts;
  let dt = (ts - lastTime) / 1000;
  if(dt > 0.05) dt = 0.05;
  lastTime = ts;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

function endGame(){
  running = false;
  started = false;
  // stop bgm, play gameover once
  try{ bgm.pause(); }catch(e){}
  try{ gameoverSound.currentTime = 0; gameoverSound.play().catch(()=>{}); }catch(e){}
  // score / highscore
  const earned = score;
  let newHigh = false;
  if(earned > highScore){
    highScore = earned;
    localStorage.setItem(STORAGE_KEY, String(highScore));
    highEl.textContent = highScore;
    newHigh = true;
  }
  showResultPanel(earned, newHigh);
}

// ----------------- 結果パネル -----------------
function showResultPanel(earned, newHigh){
  panelContent.innerHTML = '';
  const title = document.createElement('div'); title.style.fontSize='18px'; title.style.fontWeight='700'; title.textContent = 'ゲームオーバー';
  const text = document.createElement('div'); text.style.marginTop='10px'; text.textContent = `獲得金額: ${earned} 円`;
  const hs = document.createElement('div'); hs.style.marginTop='8px'; hs.textContent = `ハイスコア: ${highScore} 円`;
  const btnWrapper = document.createElement('div'); btnWrapper.style.marginTop='12px'; btnWrapper.style.display='flex'; btnWrapper.style.justifyContent='flex-end'; btnWrapper.style.gap='8px';
  const titleBtn = document.createElement('button'); titleBtn.textContent = 'タイトルに戻る'; titleBtn.onclick = ()=>{ overlay.classList.add('hidden'); startBtn.style.display = 'block'; };
  const retryBtn = document.createElement('button'); retryBtn.textContent = 'もう一度プレイ'; retryBtn.className = 'secondary'; retryBtn.onclick = ()=>{ overlay.classList.add('hidden'); startGame(); };
  btnWrapper.appendChild(titleBtn); btnWrapper.appendChild(retryBtn);

  panelContent.appendChild(title);
  panelContent.appendChild(text);
  if(newHigh){
    const nh = document.createElement('div'); nh.style.marginTop='8px'; nh.style.color='#d9534f'; nh.textContent = '新記録！おめでとうございます！';
    panelContent.appendChild(nh);
    triggerConfetti();
  }
  panelContent.appendChild(hs);
  panelContent.appendChild(btnWrapper);

  overlay.classList.remove('hidden');
}

// confetti (simple)
function triggerConfetti(){
  confettiArea.innerHTML = '';
  const N = 40;
  for(let i=0;i<N;i++){
    const el = document.createElement('i');
    el.style.position = 'absolute';
    el.style.left = (Math.random()*100)+'%';
    el.style.top = (Math.random()*10)+'%';
    el.style.background = `hsl(${Math.random()*360} 80% 60%)`;
    el.style.transform = `rotate(${Math.random()*360}deg)`;
    el.style.opacity = 1;
    el.style.width = (Math.random()*10+6)+'px';
    el.style.height = (Math.random()*12+8)+'px';
    el.style.borderRadius = '2px';
    confettiArea.appendChild(el);
    const dx = (Math.random()*2-1)*200;
    const dy = 600 + Math.random()*400;
    el.animate([
      { transform: el.style.transform, opacity:1, top: el.style.top },
      { transform: `translate(${dx}px, ${dy}px) rotate(${Math.random()*720}deg)`, opacity:0, top: (60+Math.random()*40) + '%' }
    ], { duration:1200+Math.random()*800, easing:'cubic-bezier(.2,.8,.2,1)' });
  }
  setTimeout(()=>{ confettiArea.innerHTML=''; }, 2000);
}

// ----------------- 入力処理 -----------------
// keyboard
window.addEventListener('keydown', e=>{
  if(e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A'){ keys.left = true; }
  if(e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D'){ keys.right = true; }
  if(e.key === ' ' || e.code === 'Space'){
    if(player && player.onGround){ player.vy = -980; player.onGround = false; }
  }
});
window.addEventListener('keyup', e=>{
  if(e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A'){ keys.left = false; }
  if(e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D'){ keys.right = false; }
});

// mouse fallback for buttons
leftBtn.addEventListener('mousedown', ()=>{ touchLeft = true; });
leftBtn.addEventListener('mouseup', ()=>{ touchLeft = false; });
rightBtn.addEventListener('mousedown', ()=>{ touchRight = true; });
rightBtn.addEventListener('mouseup', ()=>{ touchRight = false; });

// touch events (preventDefault to avoid text selection / copy)
leftBtn.addEventListener('touchstart', e=>{ e.preventDefault(); touchLeft = true; });
leftBtn.addEventListener('touchend', e=>{ e.preventDefault(); touchLeft = false; });
rightBtn.addEventListener('touchstart', e=>{ e.preventDefault(); touchRight = true; });
rightBtn.addEventListener('touchend', e=>{ e.preventDefault(); touchRight = false; });

// ensure that long press on buttons doesn't trigger selection/menu
[leftBtn, rightBtn, startBtn].forEach(el=>{
  el.addEventListener('touchcancel', e=>{ e.preventDefault(); touchLeft = touchRight = false; }, { passive:false });
});

// prevent accidental selection on drag
document.addEventListener('selectstart', e=> e.preventDefault());

// ----------------- スタート / UI 操作 -----------------
startBtn.addEventListener('click', ()=>{
  startBtn.style.display = 'none';
  // startGame must be called from a user gesture for audio autoplay rules
  startGame();
});

// initialize screen: show central start button and draw an initial idle frame
resetGame();
ensureStartingPlatforms();
draw(); // initial draw so user sees something

// idle drawing to keep screen responsive even when not running
(function idle(){
  if(!running){
    draw();
  }
  requestAnimationFrame(idle);
})();

// ensure canvas resized on first layout
setTimeout(resizeCanvas, 50);
</script>
</body>
</html>
