<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>„Å≠„Åì„Ç∏„É£„É≥„Éó ‚Äî ‰øÆÊ≠£Áâà</title>
<style>
:root{--bg:#cfe9ff;--panel:#ffffffcc;--accent:#ff7b6b}
*{box-sizing:border-box;user-select:none;-webkit-user-select:none;-ms-user-select:none}
html,body{height:100%;margin:0;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;background:linear-gradient(#cfe9ff,#eaf7ff);}
#gameWrap{max-width:640px;margin:0 auto;padding:8px;background:var(--panel);border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.12);position:relative;height:100vh;display:flex;flex-direction:column;justify-content:flex-start}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
h1{font-size:18px;margin:0}
.controls{display:flex;gap:8px;align-items:center}
button{background:var(--accent);border:none;padding:8px 14px;border-radius:8px;color:#fff;font-weight:600;cursor:pointer}
button.secondary{background:#666}
#canvas{background:linear-gradient(#e8f6ff,#ffffff);display:block;border-radius:8px;width:100%;flex:1}
.touchpad{display:flex;gap:40px;margin-top:8px;justify-content:center}
.tp-btn{width:90px;height:70px;border-radius:12px;border:2px solid #555;background:#fff;font-size:22px}
.overlay{position:fixed;left:0;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.25);z-index:40}
.panel{background:#fff;padding:14px;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,.18);min-width:260px}
.hidden{display:none}
.confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:50}
</style>
</head>
<body>
<div id="gameWrap">
  <header>
    <h1>„Å≠„Åì„Ç∏„É£„É≥„Éó</h1>
    <div class="controls">
      <div style="font-size:13px">Áç≤Âæó: <span id="score">0</span> ÂÜÜ</div>
      <div style="font-size:13px">„Éè„Ç§„Çπ„Ç≥„Ç¢: <span id="high">0</span> ÂÜÜ</div>
      <button id="startBtn">„Çπ„Çø„Éº„Éà</button>
    </div>
  </header>
  <canvas id="canvas" width="480" height="640"></canvas>
  <div class="touchpad">
    <button class="tp-btn" id="leftBtn">‚óÄ</button>
    <button class="tp-btn" id="rightBtn">‚ñ∂</button>
  </div>
</div>

<div id="overlay" class="overlay hidden">
  <div class="panel" id="panelContent"></div>
</div>
<div id="confettiArea" class="confetti"></div>

<script>
// --- Ë®≠ÂÆö ---
const CAT_IMAGE_PATH = 'cat.png';
const BGM_PATH = 'bgm.mp3'; // „É´„Éº„ÉóBGM„ÅÆ„Éë„Çπ
const GAMEOVER_SOUND_PATH = 'gameover.mp3'; // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÊôÇ„ÅÆÂäπÊûúÈü≥„Éë„Çπ
const COIN_VALUE = 50;
const STORAGE_KEY = 'neko_jump_highscore_v1';

// BGM & ÂäπÊûúÈü≥
let bgm = new Audio(BGM_PATH);
bgm.loop = true;
let gameoverSound = new Audio(GAMEOVER_SOUND_PATH);

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const scoreEl = document.getElementById('score');
const highEl = document.getElementById('high');
const overlay = document.getElementById('overlay');
const panelContent = document.getElementById('panelContent');
const confettiArea = document.getElementById('confettiArea');

let W = canvas.width, H = canvas.height;
let keys = {left:false,right:false};
let touchLeft=false,touchRight=false;

// „Ç≤„Éº„É†Áä∂ÊÖã
let player, platforms, coins, score, highScore, running, started, lastTime;

// „Çπ„Ç≥„Ç¢Ë™≠„ÅøËæº„Åø
highScore = parseInt(localStorage.getItem(STORAGE_KEY) || '0',10) || 0;
highEl.textContent = highScore;

// Áå´ÁîªÂÉè
let catImg = new Image();
let catLoaded = false;
catImg.src = CAT_IMAGE_PATH;
catImg.onload = ()=>{ catLoaded = true; };
catImg.onerror = ()=>{ catLoaded = false; };

function rand(min,max){ return Math.random()*(max-min)+min; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

function resetGame(){
  player = { x: W/2, y: H - 120, w:48, h:48, vx:0, vy:0, onGround:false };
  platforms = [];
  coins = [];
  score = 0;
  scoreEl.textContent = score;
  running = false;
  started = false;
  lastTime = null;
}

function ensureStartingPlatforms(){
  platforms.push({ x: Math.floor(W*0.15), y: H - 36, w: Math.floor(W*0.7), h:12, moving:false, dir:1 });
  platforms.push({ x: W/2 - 80, y: H - 140, w:120, h:12, moving:false, dir:1 });
  platforms.push({ x: W/2 + 100, y: H - 240, w:100, h:12, moving:false, dir:1 });
  coins.push({ x: W/2 - 20, y: H - 160, r:9, claimed:false });
  coins.push({ x: W/2 + 140, y: H - 260, r:9, claimed:false });
}

function startGame(){
  resetGame();
  ensureStartingPlatforms();
  player.x = W/2;
  player.y = H - 220;
  running = true;
  started = true;
  lastTime = null;
  overlay.classList.add('hidden');
  startBtn.disabled = true;
  bgm.currentTime = 0;
  bgm.play().catch(()=>{});
  requestAnimationFrame(loop);
}

function spawnPlatformsIfNeeded(){
  const minY = platforms.length ? Math.min(...platforms.map(p=>p.y)) : H;
  const genTarget = -1200;
  let highest = minY;
  while(highest > genTarget){
    const step = rand(80, 160);
    const newY = highest - step;
    const w = rand(60, 160);
    const last = platforms.reduce((a,b)=> a.y < b.y ? a : b, platforms[0]);
    const baseX = last ? (last.x + last.w/2) : W/2;
    const maxXOffset = 160;
    let x = clamp(baseX + rand(-maxXOffset, maxXOffset) - w/2, 12, W - w - 12);
    const moving = Math.random() < 0.12;
    platforms.push({ x:x, y:newY, w:w, h:12, moving:moving, dir: Math.random()<0.5?1:-1 });
    if(Math.random() < 0.35){
      coins.push({ x: x + w/2, y: newY - 28, r:9, claimed:false });
    }
    highest = newY;
  }
}

function update(dt){
  if(!running) return;
  const targetVx = (keys.left||touchLeft) ? -260 : (keys.right||touchRight) ? 260 : 0;
  player.vx += (targetVx - player.vx) * 0.12;
  player.vy += 2000 * dt;
  player.x += player.vx * dt;
  player.y += player.vy * dt;
  player.x = clamp(player.x, 20, W-20);

  for(const p of platforms){
    if(p.moving){ p.x += p.dir * 60 * dt; if(p.x < 8) p.dir = 1; if(p.x + p.w > W-8) p.dir = -1; }
  }

  player.onGround = false;
  const prevBottom = player.y - player.vy*dt + player.h/2;
  const curBottom = player.y + player.h/2;
  for(const p of platforms){
    const platTop = p.y;
    if(prevBottom <= platTop && curBottom >= platTop){
      if(player.x + player.w/2 > p.x && player.x - player.w/2 < p.x + p.w){
        player.y = platTop - player.h/2;
        player.vy = -820;
        player.onGround = true;
      }
    }
  }

  for(const c of coins){
    if(c.claimed) continue;
    const dx = player.x - c.x;
    const dy = player.y - c.y;
    if(Math.hypot(dx,dy) < c.r + player.h/2 - 6){
      c.claimed = true;
      score += COIN_VALUE;
      scoreEl.textContent = score;
    }
  }

  const upper = H * 0.35;
  if(player.y < upper){
    const diff = upper - player.y;
    player.y = upper;
    for(const p of platforms) p.y += diff;
    for(const c of coins) c.y += diff;
  }

  platforms = platforms.filter(p => p.y < H + 300);
  coins = coins.filter(c => !c.claimed && c.y < H + 300);

  spawnPlatformsIfNeeded();

  if(player.y - player.h/2 > H + 80){
    endGame();
  }
}

function draw(){
  ctx.clearRect(0,0,W,H);
  for(const p of platforms){
    ctx.fillStyle = '#7a5a3c';
    ctx.fillRect(p.x, p.y - p.h, p.w, p.h);
    ctx.fillStyle = '#cfa';
    ctx.fillRect(p.x+4, p.y - p.h - 6, p.w-8, 6);
  }
  for(const c of coins){ if(c.claimed) continue; ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI*2); ctx.fillStyle='#ffd700'; ctx.fill(); ctx.strokeStyle='#c78f00'; ctx.stroke(); }
  const px = player.x, py = player.y;
  if(catLoaded){ ctx.drawImage(catImg, px - player.w/2, py - player.h/2, player.w, player.h); }
  else {
    ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.ellipse(px, py, player.w/2+2, player.h/2+2,0,0,Math.PI*2); ctx.fill();
    ctx.font = '34px serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('üò∫', px, py);
  }
}

function loop(ts){
  if(!running) return;
  if(!lastTime) lastTime = ts;
  let dt = (ts - lastTime)/1000;
  if(dt > 0.05) dt = 0.05;
  lastTime = ts;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

function endGame(){
  running = false;
  started = false;
  startBtn.disabled = false;
  bgm.pause();
  gameoverSound.currentTime = 0;
  gameoverSound.play().catch(()=>{});
  let earned = score;
  let newHigh = false;
  if(earned > highScore){
    highScore = earned;
    localStorage.setItem(STORAGE_KEY, String(highScore));
    highEl.textContent = highScore;
    newHigh = true;
  }
  showResultPanel(earned, newHigh);
}

function showResultPanel(earned, newHigh){
  panelContent.innerHTML = '';
  const title = document.createElement('div'); title.style.fontSize='18px'; title.style.fontWeight='700'; title.textContent = '„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº';
  const text = document.createElement('div'); text.style.marginTop='8px'; text.textContent = `Áç≤ÂæóÈáëÈ°ç: ${earned} ÂÜÜ`;
  const hs = document.createElement('div'); hs.style.marginTop='6px'; hs.textContent = `„Éè„Ç§„Çπ„Ç≥„Ç¢: ${highScore} ÂÜÜ`;
  const btn = document.createElement('button'); btn.textContent = '„Çø„Ç§„Éà„É´„Å´Êàª„Çã'; btn.style.marginTop='10px'; btn.onclick = ()=>{ overlay.classList.add('hidden'); };
  const retry = document.createElement('button'); retry.textContent = '„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§'; retry.className='secondary'; retry.style.marginLeft='8px'; retry.onclick = ()=>{ overlay.classList.add('hidden'); startGame(); };
  panelContent.appendChild(title); panelContent.appendChild(text); panelContent.appendChild(hs); panelContent.appendChild(btn); panelContent.appendChild(retry);
  overlay.classList.remove('hidden');
}

startBtn.addEventListener('click', startGame);
document.getElementById('leftBtn').addEventListener('touchstart', e=>{ e.preventDefault(); touchLeft=true; });
document.getElementById('leftBtn').addEventListener('touchend', e=>{ e.preventDefault(); touchLeft=false; });
document.getElementById('rightBtn').addEventListener('touchstart', e=>{ e.preventDefault(); touchRight=true; });
document.getElementById('rightBtn').addEventListener('touchend', e=>{ e.preventDefault(); touchRight=false; });

document.addEventListener('keydown', e=>{ if(e.code==='ArrowLeft'||e.code==='KeyA') keys.left=true; if(e.code==='ArrowRight'||e.code==='KeyD') keys.right=true; if(e.code==='Space' && player) player.vy=-820; });
document.addEventListener('keyup', e=>{ if(e.code==='ArrowLeft'||e.code==='KeyA') keys.left=false; if(e.code==='ArrowRight'||e.code==='KeyD') keys.right=false; });
</script>
</body>
</html>
